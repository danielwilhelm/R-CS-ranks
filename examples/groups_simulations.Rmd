---
title: "Groups simulations"
author: "Pawel Morgen, Daniel Wilhelm"
date: "2023-04-22"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Simulation setup

```{r simul_setup, cache=TRUE}
library(csranks) # make sure to install version from rrreg-grouping branch
#library(mvtnorm)
library(dplyr)
library(ggplot2)
library(parallel)
theme_set(theme_bw())
set.seed(2023)
R <- 100
G <- 4
theta_1 <- rep(0, G)
theta_2 <- rep(0.7, G)
theta_mixed <- c(0, 0.7, 0, 0.7)
true_Sigma_1 <- matrix(c(1, theta_1,
                         theta_1, 1), nrow = 2)
true_Sigma_2 <- matrix(c(1, theta_2,
                         theta_2, 1), nrow = 2)

n_g_small <- rep(50, G)
n_g_large <- rep(200, G)
n_g_mixed <- c(50, 50, 200, 200)

grouping_f_small <- factor(rep(LETTERS[1:G], times=n_g_small))
grouping_f_large <- factor(rep(LETTERS[1:G], times=n_g_large))
grouping_f_mixed <- factor(rep(LETTERS[1:G], times=n_g_mixed))

conduct_simulation <- function(num_samples, grouping_f, distribution, theta,
                               num.cores = NULL){
  if(distribution == "Gaussian"){
    sampling_f <- mvtnorm::rmvnorm
    p_f <- pnorm
  } else if(distribution == "t"){
    sampling_f <- mvtnorm::rmvt
    p_f <- function(q) pt(q, 1)
  } else cli::cli_abort("Not implemented")
  if(is.null(num.cores))
    num.cores <- parallelly::availableCores()
  type <- ifelse(parallelly::supportsMulticore(),
                 "FORK",
                 "PSOCK")
  cl <- makeCluster(num.cores, type)
  clusterSetRNGStream(cl, 2023)
  clusterExport(cl, c("grouping_f", "theta", "sampling_f", "p_f"), envir = environment())
  sim <- parLapply(cl, 1:num_samples, function(i, grouping_f, theta, sampling_f, p_f){
    sample <- matrix(nrow = length(grouping_f), ncol = 2)
    for (j in 1:length(levels(grouping_f))){
      group_indicator <- grouping_f == levels(grouping_f)[j]
      true_sigma <- matrix(c(1, theta[j],
                             theta[j], 1), nrow = 2)
      level_sample <- sampling_f(sum(group_indicator), 
                                 sigma = true_sigma)
      sample[group_indicator,] <- level_sample
    }
    copula_df <- data.frame(y = p_f(sample[,2]),
                            x = p_f(sample[,1]))
    grouped_model <- csranks::grouped_lmranks(r(y) ~ r(x), data = copula_df, 
                                     grouping_factor = grouping_f)
    coefs <- coef(grouped_model)
    csranks_vcov <- csranks::calculate_grouped_lmranks_covariances(grouped_model)
    vcov_vcov <- vcov(grouped_model)
    vcovHC_vcov <- sandwich::vcovHC(grouped_model)
    
    covariance_matrices <- sapply(list(csranks= csranks_vcov,
                                       vcov = vcov_vcov,
                                       vcovHC = vcovHC_vcov), 
                                  function(x) {sapply(x, function(x) x, simplify = "array")}, 
                                  simplify = "array")
    # covariance_matrices is an array of size n_coefs x n_coefs x n_groups x n_vcov_methods
    out <- list(coefs = coefs, covariance_matrices = covariance_matrices)
    out
  }, grouping_f=grouping_f, theta=theta, sampling_f=sampling_f, p_f=p_f)
  stopCluster(cl)
  return(sim)
}

extract_estimates_from_simulation_results <- function(res){
  coefs_across_clusters <- sapply(res, function(l){
    l$coefs}, simplify = "array")
  mean_coefs <- apply(coefs_across_clusters, MARGIN = c(1,2), FUN = mean)
  coef_names <- dimnames(coefs_across_clusters)[[1]]
  cluster_names <- dimnames(coefs_across_clusters)[[2]]
  empirical_covariances <- sapply(1:dim(coefs_across_clusters)[2], function(i) {
      cov_mat <- cov(t(coefs_across_clusters[,i,]))
      vec <- c(cov_mat[1,1], cov_mat[2,2], cov_mat[1,2])
      names(vec) <- c(paste0("var_", coef_names),
                      paste0(c("covar" ,coef_names), collapse="_"))
      vec
    })
  colnames(empirical_covariances) <- cluster_names
  empirical_df <- as_tibble(empirical_covariances, rownames = "parameter") %>%
    tidyr::pivot_longer(-1, names_to = "cluster") %>%
    mutate(method = "empirical")
  
  cov_matrices_across_clusters <- sapply(res, function(l){
      l$covariance_matrices
    }, simplify = "array")
  mean_cov_matrices <- apply(cov_matrices_across_clusters, MARGIN = c(1,2,3,4), FUN = mean)
  est_df <- apply(mean_cov_matrices, c(3,4), function(cov_mat){
    vec <- c(cov_mat[1,1], cov_mat[2,2], cov_mat[1,2])
    names(vec) <- c(paste0("var_", coef_names),
                    paste0(c("covar" ,coef_names), collapse="_"))
    vec
  }) %>% as_tibble(rownames = "parameter") %>%
    tidyr::pivot_longer(-1, names_to = c("cluster", "method"), names_sep = "\\.")
  
  rbind(empirical_df, est_df)
}
```

## Example usage

```{r example_usage}
conduct_simulation(1, grouping_f_small, "Gaussian", theta_1)
```

## Scenario 1

```{r sim_scenario_1, cache=TRUE, dependson="simul_setup"}
normal_sample_1 <- conduct_simulation(R, grouping_f_small, "Gaussian", theta_1)
t_sample_1 <- conduct_simulation(R, grouping_f_small, "t", theta_1)
```

```{r postprocess_scenario_1}
normal_ests <- extract_estimates_from_simulation_results(normal_sample_1)
t_ests <- extract_estimates_from_simulation_results(t_sample_1)
normal_annotated <- mutate(normal_ests, distribution = "Gaussian")
t_annotated <- mutate(t_ests, distribution = "t-Student")
results_1 <- rbind(normal_annotated, t_annotated)
```

```{r visualize_scenario_1}

ggplot(results_1, aes(x = cluster, y = value, col = method, shape = parameter)) +
  geom_point() +
  facet_wrap(~distribution)+
  labs(title = "Comparison between empirical and implemented variance estimates",
       subtitle = "Small, equal clusters; no correlation")
knitr::kable(
  tidyr::pivot_wider(results_1, c("distribution", "cluster","parameter"), 
                   names_from = c("method")) %>%
    arrange(distribution, cluster, parameter)
  )
```

## Scenario 2

```{r sim_scenario_2, cache=TRUE, dependson="simul_setup"}
normal_sample_2 <- conduct_simulation(R, grouping_f_small, "Gaussian", theta_2)
t_sample_2 <- conduct_simulation(R, grouping_f_small, "t", theta_2)
```

```{r postprocess_scenario_2}
normal_ests <- extract_estimates_from_simulation_results(normal_sample_2)
t_ests <- extract_estimates_from_simulation_results(t_sample_2)
normal_annotated <- mutate(normal_ests, distribution = "Gaussian")
t_annotated <- mutate(t_ests, distribution = "t-Student")
results_2 <- rbind(normal_annotated, t_annotated)
```

```{r visualize_scenario_2}

ggplot(results_2, aes(x = cluster, y = value, col = method, shape = parameter)) +
  geom_point() +
  facet_wrap(~distribution)+
  labs(title = "Comparison between empirical and implemented variance estimates",
       subtitle = "Small, equal clusters; strong correlation")
knitr::kable(
  tidyr::pivot_wider(results_2, c("distribution", "cluster","parameter"), 
                   names_from = c("method")) %>%
    arrange(distribution, cluster, parameter)
)
```

## Scenario 3

```{r sim_scenario_3, cache=TRUE, dependson="simul_setup"}
normal_sample_3 <- conduct_simulation(R, grouping_f_large, "Gaussian", theta_1)
t_sample_3 <- conduct_simulation(R, grouping_f_large, "t", theta_1)
```

```{r postprocess_scenario_3}
normal_ests <- extract_estimates_from_simulation_results(normal_sample_3)
t_ests <- extract_estimates_from_simulation_results(t_sample_3)
normal_annotated <- mutate(normal_ests, distribution = "Gaussian")
t_annotated <- mutate(t_ests, distribution = "t-Student")
results_3 <- rbind(normal_annotated, t_annotated)
```

```{r visualize_scenario_3}
ggplot(results_3, aes(x = cluster, y = value, col = method, shape = parameter)) +
  geom_point() +
  facet_wrap(~distribution)+
  labs(title = "Comparison between empirical and implemented variance estimates",
       subtitle = "Large, equal clusters; no correlation")
knitr::kable(
  tidyr::pivot_wider(results_3, c("distribution", "cluster","parameter"), 
                   names_from = c("method")) %>%
    arrange(distribution, cluster, parameter)
)
```

## Scenario 4

```{r sim_scenario_4, cache=TRUE, dependson="simul_setup"}
normal_sample_4 <- conduct_simulation(R, grouping_f_large, "Gaussian", theta_2)
t_sample_4 <- conduct_simulation(R, grouping_f_large, "t", theta_2)
```

```{r postprocess_scenario_4}
normal_ests <- extract_estimates_from_simulation_results(normal_sample_4)
t_ests <- extract_estimates_from_simulation_results(t_sample_4)
normal_annotated <- mutate(normal_ests, distribution = "Gaussian")
t_annotated <- mutate(t_ests, distribution = "t-Student")
results_4 <- rbind(normal_annotated, t_annotated)
```

```{r visualize_scenario_4}
ggplot(results_4, aes(x = cluster, y = value, col = method, shape = parameter)) +
  geom_point() +
  facet_wrap(~distribution)+
  labs(title = "Comparison between empirical and implemented variance estimates",
       subtitle = "Large, equal clusters; strong correlation")

knitr::kable(
  tidyr::pivot_wider(results_1, c("distribution", "cluster","parameter"), 
                   names_from = c("method")) %>%
    arrange(distribution, cluster, parameter)
)
```

## Scenario 5

```{r sim_scenario_5, cache=TRUE, dependson="simul_setup"}
normal_sample_5 <- conduct_simulation(R, grouping_f_mixed, "Gaussian", theta_mixed)
t_sample_5 <- conduct_simulation(R, grouping_f_mixed, "t", theta_mixed)
```

```{r postprocess_scenario_5}
normal_ests <- extract_estimates_from_simulation_results(normal_sample_5)
t_ests <- extract_estimates_from_simulation_results(t_sample_5)
normal_annotated <- mutate(normal_ests, distribution = "Gaussian")
t_annotated <- mutate(t_ests, distribution = "t-Student")
results_5 <- rbind(normal_annotated, t_annotated)
```

```{r visualize_scenario_5}
ggplot(results_5, aes(x = cluster, y = value, col = method, shape = parameter)) +
  geom_point() +
  facet_wrap(~distribution)+
  labs(title = "Comparison between empirical and implemented variance estimates",
       subtitle = "Varying clusters and correlations")
knitr::kable(
  tidyr::pivot_wider(results_1, c("distribution", "cluster","parameter"), 
                   names_from = c("method")) %>%
    arrange(distribution, cluster, parameter)
)
```